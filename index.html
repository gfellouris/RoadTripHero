<!DOCTYPE html>
<html>

<head>
  <title>Google Maps JavaScript API v3 Example: Map Simple</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
  <meta charset="utf-8">
  <style>
    html,
    body,
    #map_canvas {
      margin: 0;
      padding: 0;
      height: 100%;
    }
  </style>
  <!--Load the AJAX API-->
  <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6Zh5HsEPeyGkktmpXijxz0NerXxlDq6Q&libraries=places"></script>
  <script type="text/javascript">
    google.load('visualization', '1', { 'packages': ['corechart', 'table', 'geomap'] });
    var tableid = 1499916;
    var map = null;
    var polyline = new google.maps.Polyline({
      path: [],
      strokeColor: '#FF0000',
      strokeWeight: 3
    });
    var bounds = new google.maps.LatLngBounds();
    var directions = null;
    var distance = null; // km
    var service = null;
    var gmarkers = [];
    var boxes = null;
    var zipcodes = [];
    var infowindow = new google.maps.InfoWindow();
    function initialize() {
      // Default the map view to the continental U.S.
      var mapOptions = {
        center: new google.maps.LatLng(40, -80.5),
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        zoom: 8
      };

      map = new google.maps.Map(document.getElementById("map"), mapOptions);
      service = new google.maps.places.PlacesService(map);

      directionService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer ({ map: map });

      // If there are any parameters at eh end of the URL, they will be in  location.search
      // looking something like  "?marker=3"

      // skip the first character, we are not interested in the "?"
      var query = location.search.substring(1);

      // split the rest at each "&" character to give a list of  "argname=value"  pairs
      var pairs = query.split("&");
      for (var i = 0; i < pairs.length; i++) {
        // break each pair at the first "=" to obtain the argname and value
        var pos = pairs[i].indexOf("=");
        var argname = pairs[i].substring(0, pos).toLowerCase();
        var value = pairs[i].substring(pos + 1).toLowerCase();

        // process each possible argname  -  use unescape() if theres any chance of spaces
        if (argname == "to") { document.getElementById('to').value = unescape(value); }
        if (argname == "from") { document.getElementById('from').value = unescape(value); }
        if (argname == "dist") { document.getElementById('distance').value = parseFloat(value); }
        if (argname == "type") { document.getElementById('type').value = unescape(value); }
        if (argname == "keyword") { document.getElementById('keyword').value = unescape(value); }
        if (argname == "name") { document.getElementById('name').value = unescape(value); }
        if (argname == "submit") { route(); }
      }

    }

    function route() {
      var request = {
        origin: document.getElementById("from").value,
        destination: document.getElementById("to").value,
        travelMode: google.maps.DirectionsTravelMode.DRIVING,
      }
      // Make the directions request
      directionService.route(request, function (response, status) {
        if (status == google.maps.DirectionsStatus.OK) {
           directionsRenderer.setDirections(response);

          // zipcodes = [];
          // var path = response.routes[0].overview_path;
          // var legs = response.routes[0].legs;
          // for (i = 0; i < legs.length; i++) {
          //   var steps = legs[i].steps;
          //   console.log("Leg=" + legs[i])
          //   for (j = 0; j < steps.length; j++) {
          //     console.log("step=" + steps[j])
          //     var nextSegment = steps[j].path;
          //     for (k = 0; k < nextSegment.length; k++) {
          //       polyline.getPath().push(nextSegment[k]);
          //       bounds.extend(nextSegment[k]);
          //     }
          //   }
          // }
          // document.getElementById('zipcodes').innerHTML = "<b>zipcodes along route:</b><br>";
          // for (var i = 0; i < polyline.getPath().getLength(); i++) {
          //   //  queryForZip(polyline.getPath().getAt(i));
          // }
        } else {
          alert("Directions query failed: " + status);
        }
      });
    }

    function queryForZip(latlng) {
      //set the query using the current bounds
      var queryStr = "SELECT geometry, ZIP, latitude, longitude FROM " + tableid + " WHERE ST_INTERSECTS(geometry, CIRCLE(LATLNG" + latlng + ",1))";
      var queryText = encodeURIComponent(queryStr);
      var query = new google.visualization.Query('http://www.google.com/fusiontables/gvizdata?tq=' + queryText);
      // alert(queryStr);
      console.log("latlng=" + latlng);
      console.log("query=" + query)
      //set the callback function
      query.send(addZipCode);

    }

    function addZipCode(response) {
      if (!response) {
        alert('no response');
        return;
      }
      if (response.isError()) {
        document.getElementById('status').innerHTML += 'Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage() + "<br>";
        return;
      }
      FTresponse = response;
      //for more information on the response object, see the documentation
      //http://code.google.com/apis/visualization/documentation/reference.html#QueryResponse
      numRows = response.getDataTable().getNumberOfRows();
      numCols = response.getDataTable().getNumberOfColumns();
      /*  var queryStr = "SELECT geometry, ZIP, latitude, longitude FROM "+ tableid + " WHERE ST_INTERSECTS(geometry, RECTANGLE(LATLNG"+map.getBounds().getSouthWest()+",LATLNG"+map.getBounds().getNorthEast()+"))";   
      */
      for (i = 0; i < numRows; i++) {
        var zip = response.getDataTable().getValue(i, 1);
        var zipStr = zip.toString()
        if (!zipcodes[zipStr]) {
          zipcodes[zipStr] = zipStr;
          document.getElementById('zipcodes').innerHTML += zipStr + "<br>";
        }
      }
    }

  </script>


  <style>
    #map {
      border: 1px solid black;
    }
  </style>
</head>

<body onload="initialize();">
  <table border="1">
    <tr>
      <td valign="top">
        <div id="map" style="width: 600px; height: 500px;"></div>
      </td>
      <td>
        <div id="side_bar" style="width:200px; height: 600px; overflow: auto"></div>
      </td>
      <td>
        <div id="zipcodes"></div>
      </td>
    </tr>
  </table>
  route from <input type="text" id="from" value="san diego" />
  to <input type="text" id="to" value="new york" />
  <input type="submit" onclick="route()" /><br>
  <div id="status"></div>

  <script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
  </script>
  <script type="text/javascript">
    _uacct = "UA-162157-1";
    urchinTracker();
  </script>
</body>

</html>